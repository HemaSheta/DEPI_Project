@model List<Depi_Project.Models.CartItem>
@{
    ViewData["Title"] = "Reservation Cart";
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" />

<style>
    .cart-wrapper {
        display: grid;
        grid-template-columns: 1fr 340px;
        gap: 20px;
        align-items: start;
    }

    .cart-card {
        background: #fff;
        border-radius: 14px;
        padding: 25px;
        box-shadow: 0 5px 18px rgba(0,0,0,0.08);
    }

    .cart-header {
        font-size: 2rem;
        font-weight: 800;
        margin-bottom: 15px;
    }

    .thumb-img {
        width: 110px;
        height: 75px;
        object-fit: cover;
        border-radius: 8px;
        border: 1px solid #ddd;
    }

    .price-box {
        background: #f8f9fa;
        padding: 18px;
        border-radius: 10px;
        font-size: 1.2rem;
        box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
    }

    .checkout-btn {
        font-size: 1.2rem;
        padding: 14px 22px;
        border-radius: 12px;
        font-weight: 700;
        width: 100%;
    }

    .empty-state {
        padding: 30px;
        text-align: center;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 6px 18px rgba(0,0,0,0.04);
    }
</style>

<div class="container py-4" style="max-width:1150px;">

    <h2 class="cart-header">🛒 Reservation Cart</h2>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">@TempData["Success"]</div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }

    @if (!Model.Any())
    {
        <div class="empty-state">
            <p>Your cart is empty. Browse <a href="/Customer/Room">Rooms</a>.</p>
        </div>
    }
    else
    {
        <div class="cart-wrapper">
            <div>
                <div class="cart-card">
                    <table class="table table-hover align-middle">
                        <thead class="table-dark text-center">
                            <tr>
                                <th>Room</th>
                                <th>Preview</th>
                                <th>Dates</th>
                                <th>Price/Night</th>
                                <th>Nights</th>
                                <th>Total</th>
                                <th></th>
                            </tr>
                        </thead>

                        <tbody>
                            @foreach (var it in Model)
                            {
                                var nights = (it.CheckOut.Date - it.CheckIn.Date).Days;
                                if (nights <= 0) nights = 1;

                                <tr>
                                    <td class="text-center">
                                        <strong>@it.RoomTitle</strong><br />
                                        <span class="text-muted">Room #@it.RoomNum</span>
                                    </td>

                                    <td class="text-center">
                                        <img src="@it.Slide" class="thumb-img" />
                                    </td>

                                    <td class="text-center">
                                        <strong>@it.CheckIn.ToString("yyyy-MM-dd")</strong><br />
                                        <small class="text-muted">→ @it.CheckOut.ToString("yyyy-MM-dd")</small>
                                    </td>

                                    <td class="text-center">@it.PricePerNight.ToString("F2")</td>

                                    <td class="text-center">@nights</td>

                                    <td class="text-center fw-bold">@it.TotalPrice.ToString("F2")</td>

                                    <td class="text-center">
                                        <form asp-action="Remove" method="post" class="d-inline">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="roomId" value="@it.RoomId" />
                                            <input type="hidden" name="checkIn" value="@it.CheckIn.ToString("yyyy-MM-dd")" />
                                            <input type="hidden" name="checkOut" value="@it.CheckOut.ToString("yyyy-MM-dd")" />

                                            <button type="submit"
                                                    class="btn btn-danger btn-sm"
                                                    style="border-radius:8px;">
                                                Remove
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>

                    <div class="mt-3">
                        <form asp-action="Clear" method="post" style="display:inline-block;">
                            @Html.AntiForgeryToken()
                            <button class="btn btn-outline-secondary" type="submit">Clear Cart</button>
                        </form>
                    </div>
                </div>
            </div>

            <div>
                <div class="cart-card price-box">
                    <h5 class="mb-3">Summary</h5>
                    <div style="font-size:1.25rem;">
                        Total:
                        <strong class="text-success">@Model.Sum(i => i.TotalPrice).ToString("F2")</strong> EGP
                    </div>

                    <div class="mt-4">
                        @* Hidden antiforgery token for AJAX checkout *@
                        <form id="checkoutForm" method="post" asp-action="Checkout">
                            @Html.AntiForgeryToken()
                        </form>

                        <button id="checkoutBtn" class="btn btn-success checkout-btn mt-2">
                            Proceed to Checkout
                        </button>
                    </div>

                    <div class="mt-3 text-muted small">
                        After checkout your booking will be recorded with Payment Status = <strong>Not Paid</strong>.
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

    <script>
        $(function () {

            // Toastr messages
            var s = '@TempData["Success"]';
            var e = '@TempData["Error"]';
            if (s) toastr.success(s);
            if (e) toastr.error(e);

            // AJAX Checkout: posts antiforgery token found in the hidden form
            $("#checkoutBtn").on("click", function () {
                var btn = $(this);
                btn.prop("disabled", true).text("Processing...");

                // find token
                var tokenEl = $("#checkoutForm input[name='__RequestVerificationToken']");
                var token = tokenEl.val();

                $.ajax({
                    url: "/Customer/Cart/Checkout",
                    method: "POST",
                    headers: {
                        "RequestVerificationToken": token
                    },
                    success: function (res) {
                        if (res && res.success && res.redirect) {
                            // redirect to the provided location (server-specified)
                            window.location.href = res.redirect;
                        } else {
                            toastr.error("Unexpected server response.");
                            btn.prop("disabled", false).text("Proceed to Checkout");
                        }
                    },
                    error: function (xhr) {
                        var msg = "Something went wrong.";
                        try {
                            var j = xhr.responseJSON;
                            if (j && j.error) msg = j.error;
                            else if (xhr.responseText) msg = xhr.responseText;
                        } catch (ex) {
                        }
                        toastr.error(msg);
                        btn.prop("disabled", false).text("Proceed to Checkout");
                    }
                });
            });
        });
    </script>
}
