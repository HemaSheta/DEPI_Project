@model IEnumerable<Depi_Project.Models.Room>
@{
    ViewData["Title"] = "Available Rooms";
    var filter = ViewBag.Filter;
    var roomTypes = ViewBag.RoomTypes as IEnumerable<Depi_Project.Models.RoomType> ?? Enumerable.Empty<Depi_Project.Models.RoomType>();
    var bookedTodayIds = ViewBag.BookedTodayIds as HashSet<int> ?? new HashSet<int>();
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" />

<style>
    /* ------------------------------ */
    /*  SOLID BACKGROUND (NO GRADIENTS)
            SAME AS ROOM DETAILS PAGE
        /* ------------------------------ */
    body {
        min-height: 100vh;
        margin: 0;
        font-family: 'Inter', 'Segoe UI', Roboto, Arial, sans-serif;
        background: #0f172a; /* CLEAN SOLID DARK BLUE */
        color: #e6eef8;
    }

    .page-wrap {
        padding: 28px 18px;
        min-height: calc(100vh - 120px);
    }

    .container-custom {
        max-width: 1150px;
        margin: 0 auto;
    }

    .page-title {
        font-size: 28px;
        font-weight: 800;
        color: #fff;
        margin-bottom: 18px;
    }

    /* Search Bar */
    .search-bar-wrapper {
        margin-bottom: 20px;
        background: rgba(255,255,255,0.04);
        padding: 12px 16px;
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.05);
    }

    .search-input {
        border-radius: 10px;
        padding: 12px;
        background: #ffffff;
        border: 1px solid rgba(255,255,255,0.2);
        color: #0b1220;
        width: 100%;
    }

    .search-btn {
        white-space: nowrap;
        padding: 11px 20px;
        border-radius: 10px;
        font-weight: 700;
        border: none;
        background: #3A8DFF;
        color: white;
    }

    /* LEFT FILTER SIDEBAR */
    .filter-card {
        border-radius: 12px;
        padding: 16px;
        background: rgba(255,255,255,0.05);
        color: #e6eef8;
        border: 1px solid rgba(255,255,255,0.05);
        margin-bottom: 20px;
    }

    .form-label {
        color: #e2ebff;
    }

    .form-control, .form-select {
        border-radius: 10px;
        background: #ffffff;
        color: #0b1220;
        padding: 10px 12px;
    }

    .btn-apply {
        background: #3A8DFF;
        color: #fff;
        border: none;
        padding: 10px 12px;
        font-weight: 800;
        border-radius: 10px;
        width: 100%;
    }

    .btn-reset {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,0.2);
        color: white;
        background: transparent;
    }

    /* Rooms section layout */
    .rooms-row {
        display: flex;
        gap: 20px;
        align-items: flex-start;
    }

    .rooms-col {
        flex: 1;
    }

    .rooms-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 18px;
    }

    @@media (max-width: 991px) {
        .rooms-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @@media (max-width: 600px) {
        .rooms-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Room Card */
    .room-card {
        border-radius: 12px;
        overflow: hidden;
        background: #ffffff;
        color: #0b1220;
        box-shadow: 0 6px 18px rgba(0,0,0,0.35);
        transition: .2s;
    }

        .room-card:hover {
            transform: translateY(-6px);
        }

    .room-img {
        width: 100%;
        height: 200px;
        object-fit: cover;
    }

    .price-tag {
        background: #111;
        color: white;
        padding: 6px 10px;
        border-radius: 6px;
        font-weight: 700;
    }

    .badge-small {
        font-size: 0.72rem;
        padding: 4px 8px;
        border-radius: 999px;
        font-weight: 700;
    }

    .badge-available {
        background: #28a745;
        color: white;
    }

    .badge-booked {
        background: #fbbf24;
        color: #111;
    }

    .btn-dark-sm {
        padding: 8px 12px;
        border-radius: 8px;
        font-weight: 700;
    }
</style>

<div class="page-wrap">
    <div class="container-custom">

        <h2 class="page-title">Rooms</h2>

        <!-- Search Bar + Reset -->
        <form method="get" class="search-bar-wrapper d-flex gap-3 align-items-center">

            <!-- Preserve filter values -->
            <input type="hidden" name="roomType" value="@filter.roomType" />
            <input type="hidden" name="checkIn" value="@filter.checkIn" />
            <input type="hidden" name="checkOut" value="@filter.checkOut" />
            <input type="hidden" name="minPrice" value="@filter.minPrice" />
            <input type="hidden" name="maxPrice" value="@filter.maxPrice" />
            <input type="hidden" name="persons" value="@filter.persons" />

            <input name="search" class="search-input" placeholder="Search rooms..." value="@filter.search" />

            <button class="search-btn">Search</button>

            <a href="/Customer/Room" class="btn btn-outline-light"
               style="padding: 10px 18px; border-radius: 10px; font-weight: 600; border: 1px solid rgba(255,255,255,0.3);">
                Reset
            </a>
        </form>

        <div class="rooms-row">

            <!-- FILTER SIDEBAR -->
            <div style="min-width: 280px; max-width: 320px;">
                <div class="filter-card">
                    <form method="get">

                        <div class="mb-3">
                            <label class="form-label">Room Type</label>
                            <select name="roomType" class="form-select">
                                <option value="">All</option>
                                @foreach (var t in roomTypes)
                                {
                                    <option value="@t.RoomTypeId" @@(filter.roomType= =t.RoomTypeId ? "selected" : "" )>
                                        @t.RoomTypeName
                                    </option>
                                }
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">From</label>
                            <input name="checkIn" type="date" class="form-control" value="@filter.checkIn" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">To</label>
                            <input name="checkOut" type="date" class="form-control" value="@filter.checkOut" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Min Price</label>
                            <input name="minPrice" type="number" class="form-control" value="@filter.minPrice" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Max Price</label>
                            <input name="maxPrice" type="number" class="form-control" value="@filter.maxPrice" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">People</label>
                            <input name="persons" type="number" min="1" class="form-control" value="@filter.persons" />
                        </div>

                        <div class="d-grid" style="gap:10px;">
                            <button class="btn-apply">Apply Filters</button>
                            <a href="/Customer/Room" class="btn-reset">Reset</a>
                        </div>

                    </form>
                </div>
            </div>

            <!-- ROOMS SECTION -->
            <div class="rooms-col">
                <div class="rooms-grid">
                    @foreach (var room in Model)
                    {
                        <div>
                            <div class="room-card">
                                <img src="@room.Slide1" class="room-img" />

                                <div class="p-3">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h5 class="fw-bold mb-1">Room @room.RoomNum</h5>
                                            <small class="text-muted">@room.RoomType?.RoomTypeName</small>
                                        </div>
                                        <div class="price-tag">@room.RoomType?.Price EGP</div>
                                    </div>

                                    <p class="text-muted small mt-2">@room.Description</p>
                                </div>

                                <div class="d-flex justify-content-between align-items-center p-3 border-top">
                                    @if (bookedTodayIds.Contains(room.RoomId))
                                    {
                                        <span class="badge-small badge-booked">Booked Today</span>
                                    }
                                    else
                                    {
                                        <span class="badge-small badge-available">Available</span>
                                    }

                                    <a class="btn btn-dark btn-dark-sm" href="/Customer/Room/Details/@room.RoomId">
                                        View Details
                                    </a>
                                </div>

                            </div>
                        </div>
                    }
                </div>

                @if (!Model.Any())
                {
                    <div class="alert alert-info mt-3">No rooms match your filters.</div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const today = new Date().toISOString().split("T")[0];

            const ci = document.querySelector("input[name='checkIn']");
            const co = document.querySelector("input[name='checkOut']");

            if (ci) ci.min = today;
            if (co) co.min = today;

            function enforceDates() {
                if (!ci.value) return;

                let inDate = new Date(ci.value);
                let minOut = new Date(inDate);
                minOut.setDate(minOut.getDate() + 1);

                let minOutStr = minOut.toISOString().split("T")[0];
                co.min = minOutStr;

                if (!co.value || new Date(co.value) <= inDate)
                    co.value = minOutStr;
            }

            ci?.addEventListener("change", enforceDates);
            co?.addEventListener("change", enforceDates);
        });
    </script>
}
