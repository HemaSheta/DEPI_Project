@model IEnumerable<Depi_Project.Models.Room>
@{
    ViewData["Title"] = "Available Rooms";
    var filter = ViewBag.Filter;
    var roomTypes = ViewBag.RoomTypes as IEnumerable<Depi_Project.Models.RoomType> ?? Enumerable.Empty<Depi_Project.Models.RoomType>();
    var bookedTodayIds = ViewBag.BookedTodayIds as HashSet<int> ?? new HashSet<int>();
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" />

<style>
    .filter-card {
        border-radius: 12px;
        padding: 16px;
        background: #fff;
        box-shadow: 0 6px 18px rgba(0,0,0,0.05);
        margin-bottom: 20px;
    }
    .room-card {
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        transition: transform .2s;
        background: #fff;
    }
    .room-card:hover { transform: translateY(-6px); }
    .room-img { height: 200px; width: 100%; object-fit: cover; }
    .room-title { font-weight: 700; font-size: 1.15rem; }
    .price-tag { background: #111; color: white; padding: 6px 10px; border-radius: 6px; font-weight: 700; }
</style>

<div class="container py-4" style="max-width:1150px;">
    <h2 class="fw-bold mb-3">Rooms</h2>

    <div class="filter-card mb-4">
        <form method="get" class="row g-2">

            <div class="col-md-2">
                <label class="form-label">Room Type</label>
                <select name="roomType" class="form-select">
                    <option value="">All</option>
                    @foreach (var t in roomTypes)
                    {
                        <option value="@t.RoomTypeId" @@(filter.roomType != null && filter.roomType == t.RoomTypeId ? "selected" : "")>
                            @t.RoomTypeName
                        </option>
                    }
                </select>
            </div>

            <div class="col-md-2">
                <label class="form-label">From</label>
                <input name="checkIn" type="date" class="form-control" value="@filter.checkIn" />
            </div>

            <div class="col-md-2">
                <label class="form-label">To</label>
                <input name="checkOut" type="date" class="form-control" value="@filter.checkOut" />
            </div>

            <div class="col-md-2">
                <label class="form-label">Min Price</label>
                <input name="minPrice" type="number" step="0.01" class="form-control"
                       value="@filter.minPrice" placeholder="0" />
            </div>

            <div class="col-md-2">
                <label class="form-label">Max Price</label>
                <input name="maxPrice" type="number" step="0.01" class="form-control"
                       value="@filter.maxPrice" placeholder="Any" />
            </div>

            <div class="col-md-1">
                <label class="form-label">People</label>
                <input name="persons" type="number" min="1" class="form-control"
                       value="@(filter.persons ?? "")" />
            </div>

            <div class="col-md-6 mt-2">
                <label class="form-label">Search</label>
                <input name="search" type="text" class="form-control"
                       value="@filter.search" placeholder="Room number, type, description..." />
            </div>

            <div class="col-md-6 mt-2 d-flex align-items-end">
                <button class="btn btn-primary me-2">Apply Filters</button>
                <a href="/Customer/Room" class="btn btn-outline-secondary">Reset</a>
            </div>

        </form>
    </div>

    <div class="row">
        @foreach (var room in Model)
        {
            <div class="col-md-4 mb-4">
                <div class="room-card">
                    <img src="@room.Slide1" class="room-img" />

                    <div class="p-3">

                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <div class="room-title">Room @room.RoomNum</div>
                                <div class="text-muted small">@room.RoomType?.RoomTypeName</div>
                            </div>
                            <div class="text-end">
                                <div class="price-tag">@room.RoomType?.Price EGP</div>
                            </div>
                        </div>

                        <p class="text-muted small mb-2">@room.Description</p>

                        <div class="d-flex justify-content-between align-items-center">
                            <span class="badge @(bookedTodayIds.Contains(room.RoomId) ? "bg-warning text-dark" : "bg-success")">
                                @(bookedTodayIds.Contains(room.RoomId) ? "Booked Today" : "Available")
                            </span>

                            <a href="/Customer/Room/Details/@room.RoomId" class="btn btn-dark">View Details</a>
                        </div>

                    </div>
                </div>
            </div>
        }
    </div>

    @if (!Model.Any())
    {
        <div class="alert alert-info">No rooms found for the selected filters.</div>
    }
</div>

@section Scripts {
<script>
    document.addEventListener("DOMContentLoaded", function () {

        const today = new Date().toISOString().split("T")[0];

        const ci = document.querySelector("input[name='checkIn']");
        const co = document.querySelector("input[name='checkOut']");

        if (ci) ci.min = today;
        if (co) co.min = today;

        function enforceDates() {
            if (!ci.value) return;

            let inDate = new Date(ci.value);
            let outDate = new Date(co.value);

            let minOut = new Date(inDate);
            minOut.setDate(minOut.getDate() + 1);
            let minOutStr = minOut.toISOString().split("T")[0];

            co.min = minOutStr;

            if (!co.value || outDate <= inDate) {
                co.value = minOutStr;
            }
        }

        ci?.addEventListener("change", enforceDates);
        co?.addEventListener("change", enforceDates);
    });
</script>
}
