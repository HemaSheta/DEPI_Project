@model IEnumerable<Depi_Project.Models.Room>

@{
    ViewData["Title"] = "Available Rooms";
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" />

<h2 class="mb-4">Available Rooms</h2>

<div class="row">
    @foreach (var room in Model)
    {
        <div class="col-md-4 mb-4">
            <div class="card h-100 shadow-sm">
                <img class="card-img-top" src="@room.Slide1" style="height:200px; object-fit:cover;" />

                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">Room @room.RoomNum</h5>
                    <p class="flex-grow-1">@room.Description</p>
                    <p><strong>Type:</strong> @room.RoomType?.RoomTypeName</p>
                    <p><strong>Price: </strong>@room.RoomType?.Price EGP / night</p>

                    <div class="mb-2">
                        <div class="row gx-2">
                            <div class="col">
                                <input type="date" class="form-control form-control-sm ci-@room.RoomId" />
                            </div>
                            <div class="col">
                                <input type="date" class="form-control form-control-sm co-@room.RoomId" />
                            </div>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <a href="/Customer/Room/Details/@room.RoomId" class="btn btn-primary btn-sm">View Details</a>
                        <button class="btn btn-outline-success btn-sm add-quick" data-roomid="@room.RoomId" data-price="@room.RoomType?.Price ?? 0">Add to Cart</button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script>
    $(function () {
        $(".add-quick").click(function () {
            var roomId = $(this).data("roomid");
            var checkIn = $(".ci-" + roomId).val();
            var checkOut = $(".co-" + roomId).val();

            if (!checkIn || !checkOut) {
                toastr.error("Pick check-in and check-out dates before adding to cart.");
                return;
            }

            var payload = { roomId: parseInt(roomId), checkIn: checkIn, checkOut: checkOut };

            fetch('/Customer/Cart/Add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(r => r.json())
            .then(j => {
                if (j.success) {
                    toastr.success("Added to cart");
                    $("#cartCountBadge").text(j.count);
                } else if (j.error) {
                    toastr.error(j.error);
                } else {
                    toastr.error("Could not add to cart");
                }
            });
        });
    });
</script>
