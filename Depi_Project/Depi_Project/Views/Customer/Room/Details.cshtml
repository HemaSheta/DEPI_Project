@model Depi_Project.Models.Room

@{
    ViewData["Title"] = "Room Details";
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" />

<h2>Room @Model.RoomNum – @Model.RoomType?.RoomTypeName</h2>

<div class="row">
    <div class="col-md-7">
        <div id="roomCarousel" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-inner">
                <div class="carousel-item active">
                    <img src="@Model.Slide1" class="d-block w-100" style="height:350px;object-fit:cover;">
                </div>
                <div class="carousel-item">
                    <img src="@Model.Slide2" class="d-block w-100" style="height:350px;object-fit:cover;">
                </div>
                <div class="carousel-item">
                    <img src="@Model.Slide3" class="d-block w-100" style="height:350px;object-fit:cover;">
                </div>
            </div>

            <button class="carousel-control-prev" type="button" data-bs-target="#roomCarousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon"></span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#roomCarousel" data-bs-slide="next">
                <span class="carousel-control-next-icon"></span>
            </button>
        </div>
    </div>

    <div class="col-md-5">
        <h3>Description</h3>
        <p>@Model.Description</p>

        <h4>Room Type: @Model.RoomType.RoomTypeName</h4>
        <p><strong>Price:</strong> @Model.RoomType.Price EGP</p>
        <p><strong>People:</strong> @Model.RoomType.NumOfPeople</p>

        <h5>
            Status:
            <span class="badge bg-@(Model.Status == "Available" ? "success" : "danger")">
                @Model.Status
            </span>
        </h5>

        <hr />

        <div class="mb-2">
            <label>Check In</label>
            <input id="ci" type="date" class="form-control" />
        </div>

        <div class="mb-2">
            <label>Check Out</label>
            <input id="co" type="date" class="form-control" />
        </div>

        <div class="mt-3 d-flex gap-2">
            <button id="addToCart" class="btn btn-outline-primary">Add to Cart</button>

            @if (User.Identity.IsAuthenticated)
            {
                <a href="/Customer/Booking/Create?roomId=@Model.RoomId" class="btn btn-success">Book Now</a>
            }
            else
            {
                <a href="/Identity/Account/Login" class="btn btn-primary">Login to Book</a>
            }
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script>
    $(function () {
        $("#addToCart").click(function () {
            const checkIn = $("#ci").val();
            const checkOut = $("#co").val();

            if (!checkIn || !checkOut) {
                toastr.error("Please choose both check-in and check-out dates.");
                return;
            }

            const payload = {
                roomId: @Model.RoomId,
                checkIn: checkIn,
                checkOut: checkOut
            };

            fetch('/Customer/Cart/Add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(r => r.json())
            .then(j => {
                if (j.success) {
                    toastr.success("Added to cart");
                    updateCartBadge(j.count);
                } else if (j.error) {
                    toastr.error(j.error);
                } else {
                    toastr.error("Could not add to cart");
                }
            });
        });

        function updateCartBadge(count) {
            // try update a badge element if present
            const $b = $("#cartCountBadge");
            if ($b.length) $b.text(count);
        }
    });
</script>
