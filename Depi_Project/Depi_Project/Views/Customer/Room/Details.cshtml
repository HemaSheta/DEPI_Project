@model Depi_Project.Models.Room
@{
    ViewData["Title"] = "Room Details";
    bool isBookedToday = ViewBag.IsBookedToday ?? false;
}

<style>
    .room-header {
        font-size: 2rem;
        font-weight: 800;
        margin-bottom: 25px;
        color: #222;
    }

    .carousel-img {
        height: 400px;
        width: 100%;
        object-fit: cover;
        border-radius: 12px;
    }

    .info-box {
        background: #fff;
        padding: 25px;
        border-radius: 14px;
        border: 1px solid #e1e1e1;
        box-shadow: 0 4px 14px rgba(0,0,0,0.08);
    }

    .btn-main, .btn-cart, .btn-back {
        padding: 14px 20px;
        font-size: 1.1rem;
        font-weight: 700;
        border-radius: 10px;
        width: 100%;
    }

    .btn-cart {
        background: #17a2b8;
        color: white;
    }

    .btn-back {
        background: #6c757d;
        color: white;
    }
</style>

<h2 class="room-header">Room @Model.RoomNum — @Model.RoomType?.RoomTypeName</h2>

<div class="row">
    <div class="col-md-7 mb-4">
        <div id="carouselRoom" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-inner">

                @if (!string.IsNullOrWhiteSpace(Model.Slide1))
                {
                    <div class="carousel-item active">
                        <img src="@Model.Slide1" class="carousel-img" />
                    </div>
                }

                @if (!string.IsNullOrWhiteSpace(Model.Slide2))
                {
                    <div class="carousel-item">
                        <img src="@Model.Slide2" class="carousel-img" />
                    </div>
                }

                @if (!string.IsNullOrWhiteSpace(Model.Slide3))
                {
                    <div class="carousel-item">
                        <img src="@Model.Slide3" class="carousel-img" />
                    </div>
                }

            </div>

            <button class="carousel-control-prev" type="button" data-bs-target="#carouselRoom" data-bs-slide="prev">
                <span class="carousel-control-prev-icon"></span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#carouselRoom" data-bs-slide="next">
                <span class="carousel-control-next-icon"></span>
            </button>
        </div>
    </div>

    <div class="col-md-5">
        <div class="info-box">

            <h4>Description</h4>
            <p>@Model.Description</p>

            <p><strong>Type:</strong> @Model.RoomType?.RoomTypeName</p>
            <p><strong>Price:</strong> @Model.RoomType?.Price EGP</p>
            <p><strong>People:</strong> @Model.RoomType?.NumOfPeople</p>

            <p>
                <strong>Availability (today):</strong>
                <span class="badge @(isBookedToday ? "bg-warning text-dark" : "bg-success")">
                    @(isBookedToday ? "Booked Today" : "Available")
                </span>
            </p>

            <hr />

            <!-- Date pickers -->
            <div class="row mb-3">
                <div class="col">
                    <label class="form-label">From</label>
                    <input id="checkIn" type="date" class="form-control" />
                </div>
                <div class="col">
                    <label class="form-label">To</label>
                    <input id="checkOut" type="date" class="form-control" />
                </div>
            </div>

            <div class="mt-4 d-flex flex-column gap-3">
                @if (User.Identity.IsAuthenticated)
                {
                    <a id="bookNowBtn" href="#" class="btn btn-dark btn-main">Book Now</a>
                    <a id="addCartBtn" href="#" class="btn btn-cart">Add to Cart</a>
                }
                else
                {
                    <a href="/Identity/Account/Login" class="btn btn-primary btn-main">
                        Login to Book
                    </a>
                }

                <a href="/Customer/Room" class="btn btn-back">Back to Rooms</a>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            const today = new Date().toISOString().split("T")[0];

            const ci = document.getElementById("checkIn");
            const co = document.getElementById("checkOut");

            ci.min = today;
            co.min = today;

            function enforceDates() {
                if (!ci.value) return;

                let inDate = new Date(ci.value);
                let outDate = new Date(co.value);

                let minOut = new Date(inDate);
                minOut.setDate(minOut.getDate() + 1);
                let minOutStr = minOut.toISOString().split("T")[0];

                co.min = minOutStr;

                if (!co.value || outDate <= inDate) {
                    co.value = minOutStr;
                }
            }

            ci?.addEventListener("change", enforceDates);
            co?.addEventListener("change", enforceDates);

            const roomId = @Model.RoomId;
            const bookBtn = document.getElementById('bookNowBtn');
            const addBtn = document.getElementById('addCartBtn');

            function validDates() {
                return ci.value && co.value && new Date(co.value) > new Date(ci.value);
            }

            bookBtn?.addEventListener('click', function (e) {
                e.preventDefault();
                if (!validDates()) return alert("Please select valid dates.");

                window.location.href =
                    `/Customer/Cart/Add/${roomId}?checkIn=${ci.value}&checkOut=${co.value}`;
            });

            addBtn?.addEventListener('click', function (e) {
                e.preventDefault();
                if (!validDates()) return alert("Please select valid dates.");

                window.location.href =
                    `/Customer/Cart/Add/${roomId}?checkIn=${ci.value}&checkOut=${co.value}&stay=true`;
            });

        });
    </script>
}
